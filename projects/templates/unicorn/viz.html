<div>
    <!-- VIZ SPINNER START -->
    <!--<div unicorn:loading class="overlay">
        <div class="d-flex justify-content-center">  
            <div class="spinner-grow text-danger" role="status" style="width: 3rem; height: 3rem; z-index: 20;">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>-->
    <!-- SPINNER END -->
    <!-- PLOT -->
    {% with vids=viz.pk|stringformat:"s" %}
    {% with vid='viz-'|add:vids %}
    <div id="outerOuterPlotBox-{{vid}}" class="sticky-top" style="z-index: 995">
        <div id="outerPlotBox-{{vid}}">
            <div id="plotBox-{{vid}}">
            </div>
            <!--<script src="https://cdn.plot.ly/plotly-2.8.3.min.js"></script>-->
            <script class="youVizOnLoad youVizOnUpdate" type="application/javascript">
                {% if plot_data %}
                 var data = JSON.parse('{{plot_data|safe}}');
                 var layout = JSON.parse('{{plot_layout|safe}}');
                 //var config = {responsive: true};
                 layout.height = 370;
                 layout.margin.t = 15;
                 layout.margin.b = 68;
                 layout.margin.r = 10;
                 layout.showlegend = true;
                 layout.legend = {
                    x: 1,
                    xanchor: 'right',
                    y: 1,
                    bgcolor: '#00000000',
                 };
                 Plotly.react("plotBox-{{vid}}", data, layout, {displayModeBar: false, scrollZoom: true});

                 /*
                 resizeTarget = document.getElementById("plotBox-{{vid}}");
                 var update = {
                    width: resizeTarget.clientWidth,
                    height: resizeTarget.clientHeight
                 };
                 alert(update.width);
                 Plotly.relayout("plotBox-{{vid}}", update);
                 */
                 window.addEventListener("resize", (event) => {
                     resizeTarget = document.getElementById("plotBox-{{vid}}");
                     if (window.getComputedStyle(resizeTarget).display !== "none") {
                         var update = {
                            width: resizeTarget.clientWidth,
                            height: resizeTarget.clientHeight
                         };
                         Plotly.relayout("plotBox-{{vid}}", update);
                     }
                 });
                 var tabEl = document.querySelector("#{{vid}}-tab")
                 //console.log("query selector: " + tabEl.id);
                 tabEl.addEventListener('shown.bs.tab', function (event) {
                     //console.log("shown event: "+ event.target.id);
                     if (event.target.id === "{{vid}}-tab") { // newly activated tab
                         //event.relatedTarget // previous active tab
                         resizeTarget = document.getElementById("plotBox-{{vid}}");
                         var update = {
                            width: resizeTarget.clientWidth,
                            height: resizeTarget.clientHeight
                         };
                         Plotly.relayout("plotBox-{{vid}}", update);
                         //console.log("shown event: "+event.target.id);
                     }
                 })
                 {% endif %}
            </script>
        </div>
    </div>
    <!-- END PLOT -->
    <!-- MESSAGE BOX -->
    
    <!-- END MESSAGE BOX -->
    
    
    <!-- BOTTOM NAVBAR START -->
    <nav class="navbar fixed-bottom bg-light" id=bottom-navbar-{{vid}}>
        <div class="container-fluid d-flex">
            <button class="btn btn-outline-primary border-0" type="button" data-bs-toggle="offcanvas" 
                    data-bs-target="#offcanvasBottom-{{vid}}" aria-controls="offcanvasBottom-{{vid}}">
                <i class="bi bi-bar-chart" style="font-size: 1.2rem;"></i>
            </button>
        </div>
    </nav>
    <div class="offcanvas offcanvas-bottom" tabindex="-1" data-bs-backdrop="false" data-bs-scroll="true" 
         id="offcanvasBottom-{{vid}}" aria-labelledby="offcanvasBottomLabel" style="height: 216px;">
        <div class="offcanvas-header d-flex">
            <h5 class="offcanvas-title" id="offcanvasBottomLabel">Viz</h5>
            
            
            <!-- TAB BUTTONS -->
            <ul class="nav nav-pills px-2" id="myTab-{{vid}}" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold active" id="viz-settings-tab-{{vid}}" data-bs-toggle="pill" 
                            data-bs-target="#viz-settings-pane-{{vid}}" role="tab" aria-controls="viz-settings-pane" aria-selected="false">
                        <i class="bi bi-sliders" style="font-size: 1.2rem;"></i>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold" id="filter-tab-{{vid}}" data-bs-toggle="pill" 
                            data-bs-target="#filter-tab-pane-{{vid}}" role="tab" aria-controls="filter-tab-pane" aria-selected="false">
                        <i class="bi bi-pen" style="font-size: 1.2rem;"></i>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold" id="share-tab-{{vid}}" data-bs-toggle="pill" 
                            data-bs-target="#share-tab-pane-{{vid}}" role="tab" aria-controls="share-tab-pane" aria-selected="false">
                        <i class="bi bi-share-fill" style="font-size: 1.2rem;"></i>
                    </button>
                </li>
            </ul>
            
            
            
            <button type="button" class="btn-close text-reset ms-auto" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body small pt-0">
        
            
            
            
            <!-- TAB CONTENT -->
            <div class="tab-content mt-2" id="myTabContent-{{vid}}" unicorn:key="myTabContent-{{vid}}">
                <!-- SETTINGS TAB -->
                <div class="tab-pane fade show active" id="viz-settings-pane-{{vid}}" unicorn:key=viz-settings-pane-{{vid}} 
                     role="tabpanel" aria-labelledby="viz-settings-tab-{{vid}}">
                    <!-- SETTINGS -->
                    <div class="row g-2" unicorn:key="setting-row-01-{{vid}}">
                        <div class="col-lg-2">
                            <!-- SELECT {{forloop.counter}} -->
                            <div class="form-floating">
                                <input type="text" class="form-control" 
                                       unicorn:model.lazy="viz.title"
                                       id="vizNameText{{vid}}" unicorn:key="vizNameText{{vid}}"
                                       unicorn:partial.key="vizNameText{{vid}}"
                                       aria-label="Viz Name">
                                <label for="vizNameText{{vid}}">Name</label>
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <!-- SELECT {{forloop.counter}} -->
                            <div class="form-floating">
                                <select class="form-select" unicorn:model="viz_settings.service.saved" 
                                        id="vizServiceSelect{{vid}}" unicorn:key="vizServiceSelect{{vid}}" 
                                        unicorn:partial.id="outerPlotBox-{{vid}}" 
                                        {% comment %}unicorn:partial.key="setting-row-01-{{vid}}"{% endcomment %}
                                        aria-label="Viz Service Select">
                                    <option value="None" {% if viz_settings.service.saved == 'None' %} selected{% endif %}>Select viz</option>
                                    {% for v in viz_settings.service.available.viz %}
                                        <option {% if v == viz_settings.service.saved %}selected {% endif %}value="{{v}}">{{v}}</option>
                                    {% endfor %}
                                </select>
                                <label for="vizServiceSelect{{vid}}">Type</label>
                            </div>
                        </div>  
                        {% for key, value in viz_settings.options.items %}
                        <div class="col-lg-2">
                            <!-- SELECT {{forloop.counter}} -->
                            <div class="form-floating">
                                <select class="form-select" unicorn:model="viz_settings.options.{{key}}.saved" 
                                        id="data{{key|title}}Select{{vid}}" unicorn:key="data{{key|title}}Select{{vid}}" 
                                        unicorn:partial.id="outerPlotBox-{{vid}}" unicorn:partial.key="data{{key|title}}Select{{vid}}"
                                        aria-label="{{key|title}} Select">
                                    <option value="None" {% if value.saved == 'None' %} selected{% endif %}>Select field</option>
                                    {% for v in value.available %}
                                        <option {% if v == value.saved %}selected {% endif %}value="{{v}}">{{v}}</option>
                                    {% endfor %}
                                </select>
                                <label for="data{{key|title}}Select{{vid}}">{{key|title}}</label>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <div class="col-lg-2">
                            <!-- SWITCH 1 -->
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault{{vid}}">
                                <label class="form-check-label" for="flexSwitchCheckDefault{{vid}}">Exclude missing data</label>
                            </div>
                            <!-- SWITCH 2 -->
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="flexSwitchCheckChecked{{vid}}" checked>
                                <label class="form-check-label" for="flexSwitchCheckChecked{{vid}}">Show legend</label>
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <!-- SELECT {{forloop.counter}} -->
                            <button type="button" class="btn btn-lg btn-danger"
                                id="vizDeleteButton{{vid}}" unicorn:key="vizDeleteButton{{vid}}"
                                data-bs-toggle="modal" data-bs-target="#deleteVizConfirm{{vid}}"
                                aria-label="Viz Name">
                                    Delete viz
                            </button>
                            
                            <!-- VIZ DELETE MODAL START -->
                            <div class="modal fade yvmodal" id="deleteVizConfirm{{vid}}" data-bs-backdrop="static" data-bs-keyboard="false" 
                                 tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered modal-sm">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="staticBackdropLabel">Delete Viz</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            Would you like to delete this viz?
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" unicorn:click.discard="cancel" 
                                                    data-bs-dismiss="modal">Cancel</button>
                                            <button type="button" id="modalLogoutButton" 
                                                    {% comment %}unicorn:click="delete()"{% endcomment %}
                                                    onclick="bootstrap.Modal.getInstance('#deleteVizConfirm{{vid}}').hide(); 
                                                    document.getElementById('app-spinner').hidden = false;
                                                    Unicorn.call('app', 'deleteViz', '{{viz.pk}}');"
                                                    class="btn btn-danger">OK</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- END MODAL -->
                            
                            
                            
                            
                        </div>
                    </div>
                </div>
                <!-- FILTER TAB -->
                <div class="tab-pane fade" id="filter-tab-pane-{{vid}}" role="tabpanel" aria-labelledby="filter-tab-{{vid}}">
                     <div class="row g-2" unicorn:key="filter-row-01-{{vid}}">
                        <div class="col-lg-2">
                            {% for d in drawings %}
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="drawingAddonOne{{forloop.counter0}}">{{forloop.counter}}</span>
                                <select class="form-select" id="drawingTypeSelect{{forloop.counter0}}">
                                    <option value="DRAW_VLINE" selected>VLINE</option>
                                    <option value="DRAW_HLINE">HLINE</option>
                                    <option value="DRAW_VRECT">VRECT</option>
                                    <option value="DRAW_HRECT">HRECT</option>
                                </select>
                                <input type="text" class="form-control" unicorn:model.lazy="drawings.{{forloop.counter0}}.annotation_text"
                                           id="drawingNameText{{forloop.counter0}}" unicorn:key="drawingNameText{{forloop.counter0}}"
                                           unicorn:partial.key="filter-row-01-{{vid}}"
                                           unicorn:partial.id="outerPlotBox-{{vid}}" 
                                           aria-label="Drawing Name">
                                <input type="number" class="form-control" unicorn:model.lazy="drawings.{{forloop.counter0}}.x"
                                           id="drawingNumber{{forloop.counter0}}" unicorn:key="drawingNumber{{forloop.counter0}}"
                                           unicorn:partial.key="filter-row-01-{{vid}}"
                                           unicorn:partial.id="outerPlotBox-{{vid}}" 
                                           aria-label="Drawing Number">
                                <button type="button" id="drawingButton{{forloop.counter0}}" class="btn btn-danger" 
                                        unicorn:click="deleteDrawing({{forloop.counter0}})"
                                        unicorn:partial.key="filter-row-01-{{vid}}"
                                        unicorn:partial.id="outerPlotBox-{{vid}}">×</button>
                            </div>
                            {% endfor %}
                            <button type="button" id="addDrawingButton" class="btn btn-secondary" 
                                    unicorn:click="addDrawing('new drawing')"
                                    unicorn:partial.key="filter-row-01-{{vid}}"
                                    unicorn:partial.id="outerPlotBox-{{vid}}">Add</button>
                        </div>
                    </div>
                </div>
                
                <!-- SHARE TAB -->
                <div class="tab-pane fade" id="share-tab-pane-{{vid}}" role="tabpanel" aria-labelledby="share-tab-{{vid}}">
                     <div class="row g-2" unicorn:key="share-row-01-{{vid}}">
                        <div class="col-lg-2">      
                            <div id="viz-qrcode-{{vid}}"></div>
                            <script type="text/javascript">
                                var qrcode = new QRCode(document.getElementById("viz-qrcode-{{vid}}"), {
                                    text: "{{ request.path }}",
                                    width: 100,
                                    height: 100,
                                    colorDark : "#000000",
                                    colorLight : "#ffffff",
                                    correctLevel : QRCode.CorrectLevel.H
                                });
                            </script>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    <!--BOTTOM NAVBAR END -->
    <script type="javascript">
        //var r = document.querySelector('#offcanvasBottom-{{vid}}');
        //alert(r);
        //r.style.setProperty('--#offcanvas-height', '600px');
    </script>
    
    <div class="form-floating mx-2">
        <textarea unicorn:model.lazy="viz.comment" unicorn:partial="floatingTextarea2{{vid}}" id="floatingTextarea2{{vid}}" 
                  class="form-control" placeholder="Leave a memo here" style="height: 120px"></textarea>
        <label for="floatingTextarea2{{vid}}">Memo</label>
    </div>
    
    {% endwith %}
    {% endwith %}
</div>