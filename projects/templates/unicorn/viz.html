<div>
    <!-- SPINNER START -->
    <div unicorn:loading class="overlay">
        <div class="d-flex justify-content-center">  
            <div class="spinner-grow text-danger" role="status" style="width: 3rem; height: 3rem; z-index: 20;">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>
    <!-- SPINNER END -->
    <!-- PLOT -->
    {% with vids=viz.pk|stringformat:"s" %}
    {% with vid='viz-'|add:vids %}
    <div id="outerOuterPlotBox-{{vid}}" class="sticky-top" style="z-index: 995">
        <div id="outerPlotBox-{{vid}}">
            <div id="plotBox-{{vid}}">
            </div>
            <script src="https://cdn.plot.ly/plotly-2.8.3.min.js"></script>
            <script class="youVizOnLoad youVizOnUpdate" type="application/javascript">
                {% if plot_data %}
                 var data = JSON.parse('{{plot_data|safe}}');
                 var layout = JSON.parse('{{plot_layout|safe}}');
                 //var config = {responsive: true};
                 Plotly.react("plotBox-{{vid}}", data, layout);

                 /*
                 resizeTarget = document.getElementById("plotBox-{{vid}}");
                 var update = {
                    width: resizeTarget.clientWidth,
                    height: resizeTarget.clientHeight
                 };
                 alert(update.width);
                 Plotly.relayout("plotBox-{{vid}}", update);
                 */
                 window.addEventListener("resize", (event) => {
                     resizeTarget = document.getElementById("plotBox-{{vid}}");
                     if (window.getComputedStyle(resizeTarget).display !== "none") {
                         var update = {
                            width: resizeTarget.clientWidth,
                            height: resizeTarget.clientHeight
                         };
                         Plotly.relayout("plotBox-{{vid}}", update);
                     }
                 });
                 var tabEl = document.querySelector('button[id="{{vid}}-tab"]')
                 //console.log("query selector: " + tabEl.id);
                 tabEl.addEventListener('shown.bs.tab', function (event) {
                     //console.log("shown event: "+ event.target.id);
                     if (event.target.id === "{{vid}}-tab") { // newly activated tab
                         //event.relatedTarget // previous active tab
                         resizeTarget = document.getElementById("plotBox-{{vid}}");
                         var update = {
                            width: resizeTarget.clientWidth,
                            height: resizeTarget.clientHeight
                         };
                         Plotly.relayout("plotBox-{{vid}}", update);
                         //console.log("shown event: "+event.target.id);
                     }
                 })
                 {% endif %}
            </script>
        </div>
    </div>
    <!-- END PLOT -->
    
    
    
    
    
    
    
    <!-- TABS START -->
    <!-- TAB BUTTONS -->
    <ul class="nav nav-pills" id="myTab-{{vid}}" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="comment-tab-{{vid}}" data-bs-toggle="pill" 
                    data-bs-target="#comment-pane-{{vid}}" role="tab" aria-controls="comment-pane" aria-selected="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sticky-fill" viewBox="0 0 16 16">
  <path d="M2.5 1A1.5 1.5 0 0 0 1 2.5v11A1.5 1.5 0 0 0 2.5 15h6.086a1.5 1.5 0 0 0 1.06-.44l4.915-4.914A1.5 1.5 0 0 0 15 8.586V2.5A1.5 1.5 0 0 0 13.5 1h-11zm6 8.5a1 1 0 0 1 1-1h4.396a.25.25 0 0 1 .177.427l-5.146 5.146a.25.25 0 0 1-.427-.177V9.5z"></path>
</svg>
                Memo
              </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="viz-settings-tab-{{vid}}" data-bs-toggle="pill" 
                    data-bs-target="#viz-settings-pane-{{vid}}" role="tab" aria-controls="viz-settings-pane" aria-selected="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sliders" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3h9.05zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8h2.05zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1h9.05z"></path>
</svg>
                Settings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="advanced-settings-tab-{{vid}}" data-bs-toggle="pill" 
                    data-bs-target="#advanced-settings-pane-{{vid}}" role="tab" aria-controls="advanced-settings-pane" aria-selected="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sliders" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3h9.05zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8h2.05zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1h9.05z"></path>
</svg>
                More
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="share-tab-{{vid}}" data-bs-toggle="pill" 
                    data-bs-target="#share-tab-pane-{{vid}}" role="tab" aria-controls="share-tab-pane" aria-selected="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-share-fill" viewBox="0 0 16 16">
                    <path d="M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5z"></path>
                </svg>
                Share
            </button>
        </li>
    </ul>
    <!-- TAB CONTENT -->
    <div class="tab-content mt-2" id="myTabContent-{{vid}}" unicorn:key="myTabContent-{{vid}}">
        <!-- TAB COMMENT CONTENT -->
        <div class="tab-pane fade show active" id="comment-pane-{{vid}}" role="tabpanel" aria-labelledby="comment-tab-{{vid}}">
            
            <!-- MEMO FORM -->
            <div class="form-floating">
                <textarea unicorn:model.lazy="viz.comment" unicorn:partial="floatingTextarea2{{vid}}" id="floatingTextarea2{{vid}}" 
                          class="form-control" placeholder="Leave a memo here" style="height: 100px"></textarea>
                <label for="floatingTextarea2{{vid}}">Memo</label>
            </div>
            
        </div>
        <!-- TAB VIZ SETTINGS CONTENT -->
        <div class="tab-pane fade" id="viz-settings-pane-{{vid}}" unicorn:key=viz-settings-pane-{{vid}} 
             role="tabpanel" aria-labelledby="viz-settings-tab-{{vid}}">
            <!-- SETTINGS -->
            <div class="row g-2" unicorn:key="setting-row-01-{{vid}}">
                <div class="col-lg-2">
                    <!-- SELECT {{forloop.counter}} -->
                    <div class="form-floating">
                        <input type="text" class="form-control" 
                               unicorn:model.lazy="viz.title"
                               id="vizNameText{{vid}}" unicorn:key="vizNameText{{vid}}"
                               {% comment %} unicorn:partial.id="{{vid}}-tab" {% endcomment %} 
                               unicorn:partial.key="vizNameText{{vid}}"
                               aria-label="Viz Name">
                        <label for="vizNameText{{vid}}">Viz Name</label>
                    </div>
                </div>
                <div class="col-lg-2">
                    <!-- SELECT {{forloop.counter}} -->
                    <div class="form-floating">
                        <select class="form-select" unicorn:model="viz_settings.service.saved" 
                                id="vizServiceSelect{{vid}}" unicorn:key="vizServiceSelect{{vid}}" 
                                unicorn:partial.id="outerPlotBox-{{vid}}" unicorn:partial.key="setting-row-01-{{vid}}"
                                aria-label="Viz Service Select">
                            <option value="None" {% if viz_settings.service.saved == 'None' %} selected{% endif %}>Select viz</option>
                            {% for v in viz_settings.service.available.viz %}
                                <option {% if v == viz_settings.service.saved %}selected {% endif %}value="{{v}}">{{v}}</option>
                            {% endfor %}
                        </select>
                        <label for="vizServiceSelect{{vid}}">Viz Type</label>
                    </div>
                </div>  
             
                {% for key, value in viz_settings.options.items %}
                <div class="col-lg-2">
                    <!-- SELECT {{forloop.counter}} -->
                    <div class="form-floating">
                        <select class="form-select" unicorn:model="viz_settings.options.{{key}}.saved" 
                                id="data{{key|title}}Select{{vid}}" unicorn:key="data{{key|title}}Select{{vid}}" 
                                unicorn:partial.id="outerPlotBox-{{vid}}" unicorn:partial.key="data{{key|title}}Select{{vid}}"
                                aria-label="{{key|title}} Select">
                            <option value="None" {% if value.saved == 'None' %} selected{% endif %}>Select field</option>
                            {% for v in value.available %}
                                <option {% if v == value.saved %}selected {% endif %}value="{{v}}">{{v}}</option>
                            {% endfor %}
                        </select>
                        <label for="data{{key|title}}Select{{vid}}">{{key|title}} Field</label>
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- END SETTINGS -->

            
            
        </div>
        
        <!-- TAB MORE SETTINGS CONTENT -->
        <div class="tab-pane fade" id="advanced-settings-pane-{{vid}}" role="tabpanel" aria-labelledby="advanced-settings-tab-{{vid}}">
            
            <div class="row g-2" unicorn:key="more-row-01-{{vid}}">
                <div class="col-lg-4">
                    <!-- SWITCH 1 -->
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault{{vid}}">
                        <label class="form-check-label" for="flexSwitchCheckDefault{{vid}}">Exclude missing data</label>
                    </div>
                    <!-- SWITCH 2 -->
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="flexSwitchCheckChecked{{vid}}" checked>
                        <label class="form-check-label" for="flexSwitchCheckChecked{{vid}}">Show legend</label>
                    </div>
                </div>
                
                <div class="col-lg-2">
                    <!-- SELECT {{forloop.counter}} -->
                    <button type="button" class="btn btn-danger"
                        id="vizDeleteButton{{vid}}" unicorn:key="vizDeleteButton{{vid}}"
                        {% comment %} unicorn:partial.id="{{vid}}-tab" unicorn:partial.key="vizNameText{{vid}}" {% endcomment %}
                        unicorn:click="delete()"
                        {% comment %} onclick="Unicorn.call('app', 'deleteViz', {{viz.pk}});"  {% endcomment %}
                        aria-label="Viz Name">
                            Delete viz
                    </button>
                </div>
            </div>
        </div>
        
        <!-- TAB SHARE CONTENT -->
        <div class="tab-pane fade" id="share-tab-pane-{{vid}}" role="tabpanel" aria-labelledby="share-tab-{{vid}}">
             <div class="row g-2" unicorn:key="share-row-01-{{vid}}">
                <div class="col-lg-2">
                    
                    <div id="viz-qrcode-{{vid}}"></div>
                    <script type="text/javascript">
                        var qrcode = new QRCode(document.getElementById("viz-qrcode-{{vid}}"), {
                            text: "{{ request.path }}",
                            width: 100,
                            height: 100,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                    </script>
                </div>
            </div>
        </div>
            
    </div>
    
    {% endwith %}
    {% endwith %}
</div>