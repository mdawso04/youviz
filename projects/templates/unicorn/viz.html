{% load customfilters %}
<div unicorn:view>
    <!-- PLOT -->
    {% with vids=viz.pk|stringformat:"s" %}
    {% with vid='viz-'|add:vids %}
    
    <div class="d-none" unicorn:key="viz-no-update{{vid}}"></div>
    
    <div id="outerOuterPlotBox-{{vid}}" class="sticky-top" style="z-index: 995">
        <div id="outerPlotBox-{{vid}}">
            <script type="application/json" id="youviz:data:{{vid}}">
            {"plot_data":{{viz.viz_html.plot_data|safe}}, "plot_layout":{{viz.viz_html.plot_layout|safe}}}
            </script>
            <div id="plotBox-{{vid}}" class="viz-container"></div>
        </div>
    </div>
    
    
    {% include '../projects/editpanel/editpanel.html' %}
    
    
    
    {% if never %}
    <!-- EDIT PANEL -->
    <div class="bg-light border-none test-edit" id="{{vid}}-edit" aria-labelledby="TBD">
        
        <div class="d-flex offcanvas-header p-3">
            <h5 class="offcanvas-title me-auto" id="offcanvasBottomLabel">Chart Settings</h5>
            <!--<div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="maximize"
                       onclick="vizOffcanvasMaximize(this, '#offcanvasBottom-{{vid}}');" checked>
            </div>-->
            <button type="button" class="btn-close text-reset" onclick="Handler.navigator.toggleEdit();" aria-label="Close"></button>
        </div>
        
        <div class="offcanvas-body test-edit-inner small p-3" style="overflow-x: hidden;" id="switch">
            <!-- SETTINGS -->
            <div class="row row-cols-auto g-3 pb-3">
                <div class="col">
                    <h6 class="card-subtitle text-muted">Edit Filters</h6>
                </div>
            </div>
            
            
            
            
            
            
            <div class="row row-cols-1 g-3 pb-3" unicorn:key="filter-row-01-{{vid}}" id="filter-row-01-{{vid}}">
                {% comment %}
                <script>function previewRefresh(txt) {
                        el = '#filter-service-preview-0';
                        document.querySelector(el).innerHTML = txt;
                    }
                </script>
                {% endcomment %}
                {% for d in cache.data %}
                <div class="col" id="filter-col-{{forloop.counter0}}">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text" id="drawingAddonOne{{forloop.counter0}}">{{forloop.counter}}</span>
                        
                        <input id="filter-service-preview-{{forloop.counter0}}" type="text" class="form-control" disabled value="{{ d.service.saved|for_ui }}"/>
                        <button class="btn btn-secondary" 
                                data-bs-toggle="collapse"
                                data-bs-target="#data-modal{{forloop.counter0}}"
                                data-bs-title="Edit" 
                                data-bs-placement="top" 
                                role="button"
                                data-bs-content-id="popover-content{{forloop.counter0}}">
                            <i class="bi-gear"></i>
                        </button>
                        
                        {% comment %}
                        <button type="button" class="btn btn-secondary"><i class="bi bi-caret-up-fill"></i></button>
                        <button type="button" class="btn btn-secondary"><i class="bi bi-caret-down-fill"></i></button>
                        {% endcomment %}
                        
                        <button type="button" id="drawingButton{{forloop.counter0}}-{{vid}}" class="btn btn-danger" 
                                unicorn:click="deleteFilter({{forloop.counter0}})"
                                unicorn:partial.key="filter-row-01-{{vid}}"
                                unicorn:partial.id="outerPlotBox-{{vid}}"
                                unicorn:partial="setting-row-01-{{vid}}">
                            ×
                        </button>
                    </div>
                    
                    
                    
                    <!-- DATA EDIT COLLAPSE -->
                    <div class="collapse pt-2" id="data-modal{{forloop.counter0}}" >
                        <div class="card card-body" unicorn:key="data-modal-body{{forloop.counter0}}">
                            <div class="input-group input-group-sm pb-2">
                                <span class="input-group-text" id="data-type-select">Type</span>
                                <select class="form-select" 
                                        id="dataServiceSelect{{forloop.counter}}" 
                                        unicorn:key="dataServiceSelect{{forloop.counter}}" 
                                        unicorn:model="cache.data.{{forloop.counter0}}.service.saved" 
                                        unicorn:partial="data-modal-body{{forloop.counter0}}"
                                        {#unicorn:partial="filter-col-{{forloop.counter0}}"#}
                                        unicorn:partial.id="outerPlotBox-{{vid}}" 
                                        unicorn:partial.key="setting-row-01-{{vid}}"
                                        aria-label="Viz Service Select"
                                        onchange="document.getElementById('filter-service-preview-{{forloop.counter0}}').value=this.options[this.selectedIndex].text;">
                                    <option value="None" {% if d.service.saved == 'None' %} selected{% endif %}>Select type</option>
                                    {% for o in d.service.available.data %}
                                        <option {% if o == d.service.saved %}selected {% endif %}value="{{o}}">{{o|for_ui}}</option>
                                    {% endfor %}
                                </select>
                            </div>


                            {% for key, value in d.options.available.items %}
                            <div class="input-group input-group-sm pb-2">
                                <span class="input-group-text" id="filter-settings-{{forloop.parentloop.counter}}-{{forloop.counter0}}">{{key|title}}</span>
                                {% if value|length > 0 %}
                                    <select class="form-select" 
                                            unicorn:model="cache.data.{{forloop.parentloop.counter0}}.options.saved.{{key}}" 
                                            id="{{forloop.parentloop.counter}}-data{{key|title}}Select{{vid}}" 
                                            unicorn:partial="data-modal-body{{forloop.parentloop.counter0}}"
                                            unicorn:partial.id="outerPlotBox-{{vid}}" 
                                            unicorn:partial.key="setting-row-01-{{vid}}"
                                            aria-label="{{key|title}} Select">
                                        <option value="None" {% if not d.options.saved.key %} selected{% endif %}>Select field</option>
                                        {% for v in value %}
                                            <option {% if v == d.options.saved.key %}selected {% endif %}value="{{v}}">{{v|for_ui}}</option>
                                        {% endfor %}
                                    </select>
                                {% else %}
                                <input class="form-control" 
                                       unicorn:model.lazy="cache.data.{{forloop.parentloop.counter0}}.options.saved.{{key}}"
                                       id="{{forloop.parentloop.counter}}-data{{key|title}}Select{{vid}}"
                                       unicorn:key="{{forloop.parentloop.counter}}-data{{key|title}}Select{{vid}}" 
                                       unicorn:partial="data-modal-body{{forloop.parentloop.counter0}}"
                                       unicorn:partial.id="outerPlotBox-{{vid}}" 
                                       unicorn:partial.key="setting-row-01-{{vid}}"
                                       aria-label="{{key|title}} Input"/>
                                {% endif %}
                            </div>
                            
                            
                            
                            {% endfor %}


                            <button type="button" class="btn btn-sm btn-secondary" 
                                    data-bs-toggle="collapse"
                                    data-bs-target="#data-modal{{forloop.counter0}}">
                                Done
                            </button>
                        </div>
                    </div>
                    
                    
                    
                    
                </div>
                {% endfor %}
            </div>
            
            <div class="row row-cols-auto g-3 pb-3" unicorn:key="filter-row-02-{{vid}}">
                <div class="col">
                    <button type="button" 
                            id="addDrawingButton" 
                            class="btn btn-secondary btn-sm pe-2" 
                            unicorn:click="addFilter('new filter')"
                            unicorn:partial.key="filter-row-01-{{vid}}"
                            unicorn:partial.id="outerPlotBox-{{vid}}">
                        Add
                    </button>
                    <button type="button" 
                            id="previewDataButton" 
                            class="btn btn-secondary btn-sm" 
                            data-bs-toggle="modal" 
                            data-bs-target="#previewDataModal{{vid}}">
                        Preview data
                    </button>
                </div>
            </div>
            
            
            <div id="previewDataModal{{vid}}" 
                 class="modal fade yvmodal" 
                 data-bs-backdrop="static" 
                 data-bs-keyboard="false" 
                 tabindex="-1" 
                 aria-hidden="true">

                <style>
                .bootstrap-table .fixed-table-container .table tbody tr .card-view .card-view-title {
                    margin-right: 15px;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    min-width: 40%
                }
                </style>


            <!-- DATAFRAME START -->
                <div class="modal-dialog modal-xl modal-fullscreen-xl-down modal-dialog-scrollable" 
                     role="document">
                    <div class="modal-content">
                        <div class="modal-header border-0">
                            <h3>Data</h3>
                            <!-- TAB BUTTONS END-->
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                    <div class="modal-body pt-0">
                        <!-- TABLE -->
                        <table id="table"
                            data-toggle="table"
                            data-search="true"
                            data-show-columns="true"
                            data-show-columns-toggle-all="true"
                            data-show-toggle="true"
                            data-card-view="true">
                            <thead>
                                <tr>
                                    {% for column in viz.columns %}
                                        <th data-field="col-{{ column }}">{{ column }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in viz.records %}
                                <tr>
                                    {% for c in record %}
                                    <td>{{ c }}</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer border-0 mb-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
              </div>
            </div>
            
            
            
            
            <div class="row row-cols-auto g-3 pb-3">
                <div class="col">
                    <h6 class="card-subtitle text-muted">Edit Chart</h6>
                </div>
            </div>
            
            <div class="row row-cols-1 g-3 pb-3" unicorn:key="setting-row-01-{{vid}}">
                <div class="col">
                    <!-- SELECT {{forloop.counter}} -->
                    <div class="input-group input-group-sm">
                        <span class="input-group-text" id="viz-name-input">About</span>
                        <textarea rows="4" 
                                  class="form-control"
                                  unicorn:model.lazy="viz.description"
                                  id="vizNameText{{vid}}" 
                                  unicorn:key="vizNameText{{vid}}"
                                  unicorn:partial.id="floatingTextarea2{{vid}}"
                                  unicorn:partial.key="viz-no-update{{vid}}"
                                  aria-label="Viz Name"/>
                    </div>
                </div>
                <div class="col">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text" id="viz-type-select">Type</span>
                        <select class="form-select" 
                                unicorn:model="cache.viz.service.saved" 
                                id="vizServiceSelect{{vid}}" 
                                unicorn:key="vizServiceSelect{{vid}}" 
                                unicorn:partial.id="outerPlotBox-{{vid}}" 
                                unicorn:partial.key="setting-row-01-{{vid}}"
                                aria-label="Viz Service Select">
                            <option value="None" {% if cache.viz.service.saved == 'None' %} selected{% endif %}>Select viz</option>
                            {% for v in cache.viz.service.available.viz %}
                                <option {% if v == cache.viz.service.saved %}selected {% endif %}value="{{v}}">{{v|for_ui|title}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>  

                {% for key, value in cache.viz.options.available.items %}
                <div class="col">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text" id="viz-settings-{{forloop.counter0}}">{{key|for_ui|title}}</span>
                        <select class="form-select" 
                                unicorn:model="cache.viz.options.saved.{{key}}" 
                                id="data{{key|title}}Select{{vid}}" 
                                unicorn:key="data{{key|title}}Select{{vid}}" 
                                unicorn:partial.id="outerPlotBox-{{vid}}" 
                                {# unicorn:partial.key="data{{key|title}}Select{{vid}}" #}
                                aria-label="{{key|title}} Select">
                            <option value="None" {% if not cache.viz.options.saved.key %} selected{% endif %}>Select field</option>
                            {% for v in value %}
                                <option {% if v == cache.viz.options.saved.key %}selected {% endif %}value="{{v}}">{{v|for_ui|title}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="row row-cols-auto g-3 pb-3">
                <div class="col">
                    <h6 class="card-subtitle text-muted">Edit Layout</h6>
                </div>
            </div>
            
            {% for key, value in cache.viz.layout.available.items %}
            <div class="input-group input-group-sm pb-2">
                <span class="input-group-text" id="format-settings-{{forloop.counter}}">{{key|for_ui|title}}</span>
                <select class="form-select" 
                        unicorn:model="cache.viz.layout.saved.{{key}}" 
                        id="{{forloop.counter}}-data{{key|title}}Select{{vid}}" 
                        unicorn:partial.id="outerPlotBox-{{vid}}" 
                        unicorn:partial.key="setting-row-01-{{vid}}"
                        aria-label="{{key|title}} Select">
                    <option value="None" {% if not cache.viz.layout.saved.key %} selected{% endif %}>Select field</option>
                    {% for v in value %}
                        <option {% if v == cache.viz.layout.saved.key %}selected {% endif %}value="{{v}}">{{v|for_ui|title}}</option>
                    {% endfor %}
                </select>
            </div>
            {% endfor %}
            
            
            
            
            
            {% comment %}
            
            <div class="row row-cols-auto g-3 pb-3" unicorn:key="setting-row-02-{{vid}}">
                <div class="col">
                    <button type="button" class="btn btn-danger btn-sm"
                        id="vizDeleteButton{{vid}}" unicorn:key="vizDeleteButton{{vid}}"
                        data-bs-toggle="modal" data-bs-target="#deleteVizConfirm{{vid}}"
                        aria-label="Viz Name">
                            Delete viz
                    </button>
                </div>
            </div>

            <!-- VIZ DELETE MODAL -->
            <div class="modal fade yvmodal viz" id="deleteVizConfirm{{vid}}" data-bs-backdrop="static" data-bs-keyboard="false" 
                 tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-sm">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="staticBackdropLabel">Delete Viz</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            Would you like to delete this viz?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" unicorn:click.discard="cancel" 
                                    data-bs-dismiss="modal">Cancel</button>
                            <button type="button" id="modalLogoutButton" 
                                    {# unicorn:click="delete()" #}
                                    onclick="bootstrap.Modal.getInstance('#deleteVizConfirm{{vid}}').hide(); 
                                    Unicorn.call('app', 'deleteViz', '{{viz.pk}}');"
                                    class="btn btn-danger">OK</button>
                        </div>
                    </div>
                </div>
            </div>
            
            {% endcomment %}

            {% comment "Viz annotation gui" %}
            
            <hr class="my-4"/>

            <!-- FILTER SETTINGS -->
            <div class="row row-cols-auto g-3 pb-3" unicorn:key="filter-row-00-{{vid}}">
                <div class="col">
                    <h6 class="card-subtitle text-muted">Annotations</h6>
                </div>
            </div>
            
            <div class="row row-cols-1 g-3 pb-3" unicorn:key="filter-row-01-{{vid}}" id="filter-row-01-{{vid}}">
                {% for d in drawings %}
                <div class="col">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text" id="drawingAddonOne{{forloop.counter0}}">{{forloop.counter}}</span>
                        <input type="text" class="form-control" disabled>
                        <button class="btn btn-secondary" data-bs-toggle="popover"
                                data-bs-title="Edit" data-bs-placement="top" 
                                role="button"
                                data-bs-content-id="popover-content{{forloop.counter0}}">Edit</button>
                        <button type="button" class="btn btn-secondary"><i class="bi bi-caret-up-fill"></i></button>
                        <button type="button" class="btn btn-secondary"><i class="bi bi-caret-down-fill"></i></button>

                        <!-- POPOVER CONTENT -->
                        <div id="popover-content{{forloop.counter0}}" class="d-none">
                            <div class="input-group input-group-sm mb-3">
                                <span class="input-group-text" id="inputGroup-0">Type</span>
                                <select class="form-select" id="inputGroupSelect01">
                                    <option value="1" selected>One</option>
                                    <option value="2">Two</option>
                                    <option value="3">Three</option>
                                </select>
                            </div><div class="input-group input-group-sm mb-3">
                                <span class="input-group-text" id="inputGroup-1">x1</span>
                                <input type="text" class="form-control" aria-label="Sizing example input" 
                                         aria-describedby="inputGroup-sizing-sm">
                                <span class="input-group-text" id="inputGroup-2">x2</span>
                                <input type="text" class="form-control" aria-label="Sizing example input" 
                                         aria-describedby="inputGroup-sizing-sm">
                            </div>
                        </div>

                        <button type="button" id="drawingButton{{forloop.counter0}}-{{vid}}" class="btn btn-danger" 
                                unicorn:click="deleteDrawing({{forloop.counter0}})"
                                unicorn:partial.key="filter-row-01-{{vid}}"
                                unicorn:partial.id="outerPlotBox-{{vid}}">×</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="row row-cols-auto g-3 pb-3" unicorn:key="filter-row-02-{{vid}}">
                <div class="col">
                    <button type="button" id="addDrawingButton" class="btn btn-secondary" 
                            unicorn:click="addDrawing('new drawing')"
                            unicorn:partial.key="filter-row-01-{{vid}}"
                            unicorn:partial.id="outerPlotBox-{{vid}}">Add</button>
                </div>
            </div>
            
            {% endcomment %}
            
        </div>
        <!-- test edit inner -->
    </div>
    {% endif %}
    <!-- test edit -->
    
    {#<h6 class="card-subtitle mb-2 text-muted">{{viz.name}}</h6>#}
    {% if context.mode == 'app' %}
    <div class="form-floating mx-2">
        <textarea unicorn:model.lazy="viz.description" 
                  unicorn:partial="floatingTextarea2{{vid}}" 
                  id="floatingTextarea2{{vid}}" 
                  class="form-control text-secondary" 
                  placeholder="Leave a memo here" 
                  style="min-height: 120px; max-height: 120px;">
        </textarea>
        <label for="floatingTextarea2{{vid}}">Memo</label>
    </div>
    {% else %}
        {% is_owner request.user viz as current_user_is_owner %} 
        <div class="position-relative pt-1 mx-2 viz-text-area text-secondary ts-6"
             {% if current_user_is_owner %}onclick="Handler.navigator.toggleEdit();"{% endif %}
             id="floatingTextarea2{{vid}}">
            {% if viz.description %}{{viz.description}}{% else %}No descriptoion.{% endif %}
        </div>
    {% endif %}
    {% endwith %}
    {% endwith %}
</div>