{% load unicorn %} 
{% load pwa %}
{% load static %}
<!doctype html>
<html>
    <head>
        <title>Table</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- 5.1.3 -->
        <script>
            const Handler = {
                styles: {},
                scripts: {},
                func: {},
            };
        </script>        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" 
              rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" 
              crossorigin="anonymous" onload="Handler.styles[this.href]=true">
        <!-- 1.8.1 -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
        <!-- 1.20.2 -->
        <link rel="stylesheet" href="{% static 'projects/css/bootstrap-table.min.css' %}" onload="Handler.scripts['btc']=true"/>
        
        <script src="{% static 'projects/js/jquery-3.5.1.min.js' %}"></script>
        <script src="{% static 'projects/js/dropzone.min.js' %}"></script>
        <!-- 5.1.3 -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" 
                integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"
                onload="Handler.scripts['bs']=true"></script>
        <!-- 1.20.2 -->
        <!--<script src="{% static 'projects/js/bootstrap-table.min.js' %}" onload="Handler.scripts['bts']=true"></script>-->
        <!-- 2.14.0 -->
        <script src="{% static 'projects/js/plotly-2.14.0.min.js' %}"></script>
        <script src="{% static 'projects/js/qrcode.min.js' %}"></script>
        {% progressive_web_app_meta %}
        {% unicorn_scripts %}
        <style>
          .overlay {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: 10000;
            top: 40%;
            left: 0px;
        }
          .dropdown-toggle.no-arrow::after {
              content: none;
        }   
        </style>
    </head>

    <body id="body">
        {% csrf_token %}
        {% unicorn 'app' id='app01' %}
        <script type="application/javascript">
            
            function elementUpdate(u) {
                //update tab name on viz edit
                for (var n = 0; n < u.length; n++) {
                    var id = u[n][0];
                    var value = u[n][1];
                    document.getElementById(id).innerHTML = value;
                }
            }
            
            function tabChange(t) {
                var deactivate = document.querySelector(".dropdown-item.active:not("+t+")");
                deactivate.classList.remove("active");
                
                //var activate = document.querySelector(t);
                //var tab = bootstrap.Tab.getOrCreateInstance(triggerEl);
                //alert(tab);
                //tab.show();
                //activate.classList.add("active");
            }
            
            function updateButtonGroup() {
                
                // update dropdown-item active status
                // bootstrap tab change
                // button name
                // button enable/disable
            }
            
            function showVizOffcanvas() {
                var element = document.querySelector(".dropdown-item.active");
                var offcanvasID =  element.getAttribute("offcanvasID");
                var offcanvas = document.getElementById(offcanvasID);
                var vizOffcanvas = bootstrap.Offcanvas.getOrCreateInstance(offcanvas);
                vizOffcanvas.show();
            }
            
            function vizOffcanvasMaximize(c, oc) {
                document.querySelector(oc).classList.toggle('h-100');
            }
            
            // run on page load
            
            //move modals to body for zorder fix
            //var loginModal = document.getElementById("staticBackdrop");
            //var datatableModal = document.getElementById("modalTable");
            //var getmoreModal = document.getElementById("modalGetmore");
            //var sourcecontrolModal = document.getElementById("modalSourcecontrol");
            //var reportModal = document.getElementById("modalReport");
            //var body = document.getElementById("body");
            //body.appendChild(loginModal) 
            //body.appendChild(datatableModal) 
            //body.appendChild(getmoreModal) 
            //body.appendChild(sourcecontrolModal) 
            //body.appendChild(reportModal) 
            
            //var yvmodals = document.getElementsByClassName("yvmodal");
            var yvmodals = document.querySelectorAll('.yvmodal');
            var body = document.getElementById("body");
            for (let i = 0; i < yvmodals.length; i++) {
                body.appendChild(yvmodals[i]); 
            }
            
            Handler.vizInit = function (node) {
                //get plot div, tab
                var d = node.dataset;
                var vid = "viz-" + d.yvId;
                var plot_div = "plotBox-" + vid;
                var plot_div_el = document.getElementById(plot_div);
                var tab_div = vid;
                var tab_div_el = document.getElementById(tab_div);
                
                //get json
                var json_el = document.getElementById("youviz:data:" + vid);
                var json = JSON.parse(json_el.textContent);
                
                //make plot
                var data = json.plot_data;
                var layout = json.plot_layout;
                //var config = {responsive: true};
                layout.height = 370;
                layout.margin.t = 15;
                layout.margin.b = 68;
                layout.margin.r = 10;
                layout.showlegend = true;
                layout.legend = {
                    x: 1,
                    xanchor: 'right',
                    y: 1,
                    bgcolor: '#00000000',
                };
                Plotly.react(plot_div, data, layout, {displayModeBar: false, scrollZoom: false});

                //add resize, tab listeners
                window.addEventListener("resize", (event) => {
                 if (window.getComputedStyle(plot_div_el).display !== "none") {
                     var update = {
                        width: plot_div_el.clientWidth,
                        height: plot_div_el.clientHeight
                     };
                     Plotly.relayout(plot_div, update);
                 }
                });
                tab_div_el.addEventListener('shown.bs.tab', function (event) {
                 if (event.target.id === tab_div) { // newly activated tab
                     //event.relatedTarget // previous active tab
                     var update = {
                        width: plot_div_el.clientWidth,
                        height: plot_div_el.clientHeight
                     };
                     Plotly.relayout(plot_div, update);
                 }
                });
            }
            
            Handler.vizreportInit = function (node) {
                var d = node.dataset;
                //get modal
                const mr = document.querySelector("#modalReport");
                if (mr) {
                    bootstrap.Modal.getOrCreateInstance(mr).dispose();
                    bootstrap.Modal.getOrCreateInstance(mr);
                    document.getElementById("body").appendChild(mr);
                    
                    var arr = document.querySelectorAll(".yv-vizreport div script"); // only report viz/s
                    for (var n = 0; n < arr.length; n++) {
                        eval(arr[n].innerHTML); // run script
                    }
                }
            }
            
            // LOAD YV-COMPS
            const nodes = document.querySelectorAll(".yv-component");
            nodes.forEach(async (node) => {
                var node_data = node.dataset;
                
                fetch("./" + node_data.yvComponent + "/" + node_data.yvId)
                .then(response => {
                    return response.text() 
                })
                .then(data => {
                    node.innerHTML = data;
                    let timer = setInterval(function() {
                        if(window.Unicorn !== undefined){
                            // stop loop
                            clearInterval(timer);

                            // init component to setup after download
                            if(Handler[node_data.yvInit] !== undefined){
                                Handler[node_data.yvInit](node);
                            }

                            // init unicorn component for ajax editing
                            var u_script = document.querySelector('#' + node.id + ' script[id^="unicorn:data"]');
                            if(u_script !== undefined) {
                                Unicorn.componentInit(JSON.parse(u_script.textContent)); 
                            }

                            // activate button
                            if(document.querySelector(node_data.yvButton) !== undefined){
                                document.querySelector(node_data.yvButton).disabled = false;
                            }
                        }
                    }, 500);
                });
            });
            
            
            // LOAD VIZ
            /*
            const v = document.querySelector(".yv-viz");
            fetch("./" + v.dataset.yvComponent + "/" + v.dataset.yvId)
                .then(response => {
                    return response.text() 
                })
                .then(data => {
                    v.innerHTML = data;
                    let myVar = setInterval(function() {
                        if(window.Unicorn !== undefined){
                            // stop loop
                            clearInterval(myVar);

                            // init component to setup after download
                            if(Handler[v.dataset.yvInit] !== undefined){
                                Handler[v.dataset.yvInit](v.dataset);
                            }

                            // init unicorn component for ajax editing
                            Unicorn.componentInit(JSON.parse(document.querySelector('.yv-viz script[id^="unicorn:data"]').textContent)); 

                            // activate button
                            document.querySelector(v.dataset.yvButton).disabled = false;
                        }
                    }, 500);
                });
                */
            
            
            // LOAD DATAFRAME
            const df = document.querySelector(".yv-dataframe");
            fetch("./" + df.dataset.yvComponent + "/" + df.dataset.yvPk)
                .then(response => {
                    return response.text()
                })
                .then(data => {
                    df.innerHTML = data;
                    const m = document.querySelector("#modalTable");
                    if (m) {
                        bootstrap.Modal.getOrCreateInstance(m).dispose();
                        bootstrap.Modal.getOrCreateInstance(m);
                        document.getElementById("body").appendChild(m);
                        var $table = $('#table');
                        
                        var newScript = document.createElement("script");
                        newScript.src = "{% static 'projects/js/bootstrap-table.min.js' %}";
                        newScript.addEventListener("load", () => {
                            Handler.scripts['bts'] = true;
                        });
                        df.appendChild(newScript);
                        // JQuery for Bootstrap Table compatibility
                        let myVar = setInterval(function() {
                            if(Handler.scripts['bs'] !== undefined &&
                              Handler.scripts['btc'] !== undefined &&
                              Handler.scripts['bts'] !== undefined &&
                              $table.bootstrapTable !== undefined){
                                clearInterval(myVar);
                                //$table.bootstrapTable('resetView');
                                /*
                                $(function() {
                                    m.addEventListener('shown.bs.modal',function () {
                                        $table.bootstrapTable('resetView');
                                    });
                                });*/
                                document.querySelector(df.dataset.yvButton).disabled = false;
                            }
                        }, 500);
                        
                    }
                });
            
            // LOAD VIZREPORT
            /*
            const c = document.querySelector(".yv-vizreport");
            fetch("./" + c.dataset.yvComponent + "/" + c.dataset.yvPk)
                .then(response => {
                    return response.text()
                })
                .then(data => {
                    c.innerHTML = data;
                    const mr = document.querySelector("#modalReport");
                    if (mr) {
                        bootstrap.Modal.getOrCreateInstance(mr).dispose();
                        bootstrap.Modal.getOrCreateInstance(mr);
                        document.getElementById("body").appendChild(mr);
                        
                        var arr = document.querySelectorAll(".yv-vizreport div script"); // only report viz/s
                        for (var n = 0; n < arr.length; n++) {
                            eval(arr[n].innerHTML); // run script
                        }
                        
                        document.querySelector(c.dataset.yvButton).disabled = false;
                    }
                });
                */
            
            // popover setup
            const list = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
            list.map((el) => {
              let opts = {
                animation: false,
              }
              if (el.hasAttribute('data-bs-content-id')) {
                opts.content = document.getElementById(el.getAttribute('data-bs-content-id')).innerHTML;
                opts.html = true;
                opts.sanitize = false;
              }
              new bootstrap.Popover(el, opts);
            })
            
            //const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
            //const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));
            
            
            //global toggle to keep offcanvas open while editing data source
            var editing_file = false;
            
            //window.addEventListener("deviceorientation", (event) => {
            //    var absolute = event.absolute;
            //    var alpha    = event.alpha;
            //    var beta     = event.beta;
            //    var gamma    = event.gamma;
            //    alert(alpha);
            //}

            window.addEventListener("DOMContentLoaded", (event) => {
                Unicorn.addEventListener("updated", (component) =>{
                    
                    
                    if (component.name == 'app') {
                        // data source off canvas
                        if (editing_file == true) {
                            var testOffCanvas = document.getElementById("OFFCANVAS");
                            var bsoc = bootstrap.Offcanvas.getOrCreateInstance(testOffCanvas);
                            bsoc.hide();
                        }

                        // dropdown menus
                        var tmd = document.getElementById("tab-more-dropdown");
                        if (tmd) {
                            bootstrap.Dropdown.getOrCreateInstance(tmd).dispose();
                            bootstrap.Dropdown.getOrCreateInstance(tmd);
                        }
                        
                        var usd = document.getElementById("user-settings-dropdown");
                        if (usd) {
                            bootstrap.Dropdown.getOrCreateInstance(usd).dispose();
                            bootstrap.Dropdown.getOrCreateInstance(usd);
                        }

                        //dropzone
                        var dzElement = document.querySelector("#drop");
                        var myDropzone;
                        if (dzElement) {
                            if (dzElement.dropzone) {
                            dzElement.dropzone.destroy();
                            }
                            myDropzone = new Dropzone("#drop");
                        };
                        
                        //bootstrap table to handle return from file edit
                        //bootstrap table
                        $('#table').bootstrapTable(); // init via javascript
                        
                        // datatable modal
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                    
                    }
                    
                    if (component.name == 'login') {
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                        
                        var usd = document.getElementById("user-settings-dropdown");
                        if (usd) {
                            bootstrap.Dropdown.getOrCreateInstance(usd).dispose();
                            bootstrap.Dropdown.getOrCreateInstance(usd);
                        }
                        
                    }
                    
                    if (component.name == 'viz') {
                        /*
                        var arr = document.getElementsByClassName("youVizOnUpdate"); // only refreshed viz/s
                        for (var n = 0; n < arr.length; n++) {
                            eval(arr[n].innerHTML); // run script
                        }*/
                        //Handler.vizInit(document.querySelector('#' + component.id));
                        //alert(component.parentNode);
                        //alert(component.id);
                        //alert(component.root.parentNode);
                        Handler.vizInit(component.root.parentNode);                    
                    
                    }
                    
                    if (component.name == 'datatable') {
                        //bootstrap table
                        $('#table').bootstrapTable(); // init via javascript
                        
                        // datatable modal
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                    }
                    
                    if (component.name == 'getmore') {
                        // datatable modal
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                    }
                    
                    if (component.name == 'sourcecontrol') {
                        // datatable modal
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                    }
                    
                    if (component.name == 'report') {
                        // datatable modal
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                    }
                    
                    if (component.name == 'filecontrol') {
                        $('#table').bootstrapTable(); // init via javascript
                        
                        // datatable modal
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                    }
                    
                });
            });
        </script>
    </body>
</html>