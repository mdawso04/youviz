{% load unicorn %} 
{% load pwa %}
{% load static %}
<!doctype html>
<html>
    <head>
        <title>Table</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" 
              integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
        <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">-->
        <!-- custom css & js -->
        <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />
        <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.20.2/dist/bootstrap-table.min.css">

        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" 
                integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/bootstrap-table@1.20.2/dist/bootstrap-table.min.js"></script>
        <script src="https://cdn.plot.ly/plotly-2.14.0.min.js"></script>
        <script src="{% static 'projects/js/qrcode.min.js' %}"></script>
        {% progressive_web_app_meta %}
        {% unicorn_scripts %}
        <style>
          .overlay {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: 10000;
            top: 40%;
            left: 0px;
        }
          .dropdown-toggle.no-arrow::after {
              content: none;
            }
            
        
            
        </style>
    </head>

    <body id="body">
        {% csrf_token %}
        {% unicorn 'app' id='app01' %}
        <script type="application/javascript">
            
            function elementUpdate(u) {
                //update tab name on viz edit
                for (var n = 0; n < u.length; n++) {
                    var id = u[n][0];
                    var value = u[n][1];
                    document.getElementById(id).innerHTML = value;
                }
            }
            
            function tabChange(t) {
                var deactivate = document.querySelector(".dropdown-item.active:not("+t+")");
                deactivate.classList.remove("active");
                
                //var activate = document.querySelector(t);
                //var tab = bootstrap.Tab.getOrCreateInstance(triggerEl);
                //alert(tab);
                //tab.show();
                //activate.classList.add("active");
            }
            
            function updateButtonGroup() {
                
                // update dropdown-item active status
                // bootstrap tab change
                // button name
                // button enable/disable
            }
            
            function showVizOffcanvas() {
                var element = document.querySelector(".dropdown-item.active");
                var offcanvasID =  element.getAttribute("offcanvasID");
                var offcanvas = document.getElementById(offcanvasID);
                var vizOffcanvas = bootstrap.Offcanvas.getOrCreateInstance(offcanvas);
                vizOffcanvas.show();
            }
            
            function vizOffcanvasMaximize(c, oc) {
                document.querySelector(oc).classList.toggle('h-100');
            }
            
            // run on page load
            
            //move modals to body for zorder fix
            //var loginModal = document.getElementById("staticBackdrop");
            //var datatableModal = document.getElementById("modalTable");
            //var getmoreModal = document.getElementById("modalGetmore");
            //var sourcecontrolModal = document.getElementById("modalSourcecontrol");
            //var reportModal = document.getElementById("modalReport");
            //var body = document.getElementById("body");
            //body.appendChild(loginModal) 
            //body.appendChild(datatableModal) 
            //body.appendChild(getmoreModal) 
            //body.appendChild(sourcecontrolModal) 
            //body.appendChild(reportModal) 
            
            //var yvmodals = document.getElementsByClassName("yvmodal");
            var yvmodals = document.querySelectorAll('.yvmodal');
            var body = document.getElementById("body");
            for (let i = 0; i < yvmodals.length; i++) {
                body.appendChild(yvmodals[i]); 
            }
            
            
            // fetch dataframe component add to DOM
            //div class="yv-dataframe" 
            //             data-yv-datasource="{{ datasource.pk }}"
            //             data-yv-version="{{ datasource.last_cached }}" 
            //             data-yv-button="#datafileOpenButton">
            //        </div>
            
            const df = document.querySelector(".yv-dataframe");
            fetch("./dataframe/" + df.dataset.yvDatasource)
                .then(response => {
                    return response.text()
                })
                .then(data => {
                    document.querySelector(".yv-dataframe").innerHTML = data;
                    const m = document.querySelector("#modalTable");
                    if (m) {
                        bootstrap.Modal.getOrCreateInstance(m).dispose();
                        bootstrap.Modal.getOrCreateInstance(m);
                        document.getElementById("body").appendChild(m);
                        document.querySelector("#datafileOpenButton").disabled = false;
                    }
                });
            
            // popover setup
            
            const list = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
            list.map((el) => {
              let opts = {
                animation: false,
              }
              if (el.hasAttribute('data-bs-content-id')) {
                opts.content = document.getElementById(el.getAttribute('data-bs-content-id')).innerHTML;
                opts.html = true;
                opts.sanitize = false;
              }
              new bootstrap.Popover(el, opts);
            })
            
            //const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
            //const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));
            
            
            //global toggle to keep offcanvas open while editing data source
            var editing_file = false;
            
            //window.addEventListener("deviceorientation", (event) => {
            //    var absolute = event.absolute;
            //    var alpha    = event.alpha;
            //    var beta     = event.beta;
            //    var gamma    = event.gamma;
            //    alert(alpha);
            //}

            window.addEventListener("DOMContentLoaded", (event) => {
                Unicorn.addEventListener("updated", (component) =>{
                    
                    if (component.name == 'app') {
                        // data source off canvas
                        if (editing_file == true) {
                            var testOffCanvas = document.getElementById("OFFCANVAS");
                            var bsoc = bootstrap.Offcanvas.getOrCreateInstance(testOffCanvas);
                            bsoc.hide();
                        }

                        // dropdown menus
                        var tmd = document.getElementById("tab-more-dropdown");
                        if (tmd) {
                            bootstrap.Dropdown.getOrCreateInstance(tmd).dispose();
                            bootstrap.Dropdown.getOrCreateInstance(tmd);
                        }
                        
                        var usd = document.getElementById("user-settings-dropdown");
                        if (usd) {
                            bootstrap.Dropdown.getOrCreateInstance(usd).dispose();
                            bootstrap.Dropdown.getOrCreateInstance(usd);
                        }

                        //dropzone
                        var dzElement = document.querySelector("#drop");
                        var myDropzone;
                        if (dzElement) {
                            if (dzElement.dropzone) {
                            dzElement.dropzone.destroy();
                            }
                            myDropzone = new Dropzone("#drop");
                        };
                        
                        //bootstrap table to handle return from file edit
                        //bootstrap table
                        $('#table').bootstrapTable(); // init via javascript
                        
                        // datatable modal
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                    
                    }
                    
                    if (component.name == 'login') {
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                        
                        var usd = document.getElementById("user-settings-dropdown");
                        if (usd) {
                            bootstrap.Dropdown.getOrCreateInstance(usd).dispose();
                            bootstrap.Dropdown.getOrCreateInstance(usd);
                        }
                        
                    }
                    
                    if (component.name == 'viz') {
                        var arr = document.getElementsByClassName("youVizOnUpdate"); // only refreshed viz/s
                        for (var n = 0; n < arr.length; n++) {
                            eval(arr[n].innerHTML); // run script
                        }
                    }
                    
                    if (component.name == 'datatable') {
                        //bootstrap table
                        $('#table').bootstrapTable(); // init via javascript
                        
                        // datatable modal
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                    }
                    
                    if (component.name == 'getmore') {
                        // datatable modal
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                    }
                    
                    if (component.name == 'sourcecontrol') {
                        // datatable modal
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                    }
                    
                    if (component.name == 'report') {
                        // datatable modal
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                    }
                    
                    if (component.name == 'filecontrol') {
                        $('#table').bootstrapTable(); // init via javascript
                        
                        // datatable modal
                        // append modals to prevent z-layer issues
                        var yvmodals = document.querySelectorAll('.yvmodal');
                        var body = document.getElementById("body");
                        for (let i = 0; i < yvmodals.length; i++) {
                            body.appendChild(yvmodals[i]); 
                        }
                    }
                    
                });
            });
        </script>
    </body>
</html>